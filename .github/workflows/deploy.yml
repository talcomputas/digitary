on: [push]

env:
    NODE_VERSION: 14

name: ByggOgDeploy

jobs:
  build_and_deploy_job:
    runs-on: ubuntu-latest
    steps:
    - name: Login via Az module
      uses: azure/login@v1.1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS}}
#        enable-AzPSSession: true
#    - name: Run Az CLI script
#      run: |
#        az webapp list --query "[?state=='Running']"
    - name: Use Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v1
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Checkout
      uses: actions/checkout@v1

    - name: Clean and install dependencies
      run: npm ci

    - name: Build
      run: npm run build:ci

    - name: Test
      run: npm run test:ci

    - name: Run Azure webapp deploy action using publish profile credentials
      uses: azure/webapps-deploy@v2
      with:
        app-name: digitary
        package: dist/digitary
        publish-profile: ${{ secrets.AZURE_PUBLISH_PROFILE }}